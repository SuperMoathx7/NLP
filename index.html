<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WSP ChatBot</title>
    <!-- Bootstrap CSS for styling -->
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <!-- Marked.js for rendering Markdown from the AI -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PapaParse for reading the CSV file in the browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            background-color: #f4f7f6;
        }
        .container {
            max-width: 750px;
            margin-top: 50px;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #response {
            margin-top: 20px;
            padding: 20px;
            min-height: 100px;
            background-color: #e9ecef;
            border-radius: 5px;
            white-space: pre-wrap; /* Allows for line breaks and readable formatting */
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Phone Recommender & ChatBot</h2>
        <p>Ask for phone recommendations (e.g., "show me phones with 8GB RAM") or have a general chat.</p>
        <div class="form-group">
            <input
                type="text"
                class="form-control"
                id="userInput"
                placeholder="Enter your question"
                onkeyup="if(event.keyCode === 13) sendMessage()"
            />
        </div>
        <button class="btn btn-success btn-block" onclick="sendMessage()">Ask!</button>
        <div id="response">Your answer will appear here...</div>
    </div>

    <script>
        // Global variable to hold the parsed mobile phone data
        let mobileData = [];

        // --- 1. Load and Parse the CSV data as soon as the page loads ---
        window.onload = function () {
            Papa.parse('mobiles.csv', {
                download: true,
                header: true, // Treat the first row as headers
                dynamicTyping: true, // Automatically convert numbers
                complete: function (results) {
                    console.log("CSV data loaded and parsed successfully:", results.data);
                    mobileData = results.data;
                    document.getElementById('response').innerHTML = 'Data loaded. Ready to help you find a phone!';
                },
                error: function(error) {
                    console.error("Error loading or parsing CSV:", error);
                    document.getElementById('response').innerHTML = '<strong>Error:</strong> Could not load `mobiles.csv`. Please ensure the file is in the same directory as this HTML file.';
                }
            });
        };

        // --- 2. Main function to handle user messages ---
        async function sendMessage() {
            const input = document.getElementById('userInput').value;
            const responseDiv = document.getElementById('response');
            if (!input) {
                responseDiv.innerHTML = 'Please enter a message.';
                return;
            }

            responseDiv.innerHTML = 'Thinking...';

            // --- 3. Check if the query is phone-related ---
            const isPhoneQuery = checkForPhoneKeywords(input.toLowerCase());

            if (isPhoneQuery && mobileData.length > 0) {
                // Handle as a phone query
                const recommendations = findPhoneRecommendations(input.toLowerCase());
                responseDiv.innerHTML = recommendations;
            } else {
                // Handle as a general chat query using the API
                await getGeneralResponse(input);
            }
        }

        // --- 4. Phone-related logic ---
        function checkForPhoneKeywords(text) {
            const keywords = ["phone", "mobile", "battery", "ram", "camera", "screen", "processor", "gb", "mah", "mp", "inch", "snapdragon", "bionic"];
            return keywords.some(keyword => text.includes(keyword));
        }

        function findPhoneRecommendations(text) {
            // Simple filter extraction (can be made more advanced)
            const filters = {};
            let match;
            
            if (match = text.match(/(\d+)\s*gb/)) filters.ram = parseInt(match[1]);
            if (match = text.match(/(\d+)\s*mah/)) filters.battery = parseInt(match[1]);
            if (match = text.match(/(\d+)\s*mp/)) filters.camera = parseInt(match[1]);
            if (text.includes("snapdragon")) filters.processor = "snapdragon";
            if (text.includes("bionic")) filters.processor = "bionic";

            let filteredResults = mobileData.filter(phone => {
                let pass = true;
                if (filters.ram && (!phone.RAM_GB || phone.RAM_GB < filters.ram)) pass = false;
                if (filters.battery && (!phone.Battery_mAh || phone.Battery_mAh < filters.battery)) pass = false;
                if (filters.camera && (!phone.BackCamera_MP || phone.BackCamera_MP < filters.camera)) pass = false;
                if (filters.processor && (!phone.Processor_Full || !phone.Processor_Full.toLowerCase().includes(filters.processor))) pass = false;
                return pass;
            });

            if (filteredResults.length === 0) {
                return "I couldn't find any phones that match your criteria. Please try a different search.";
            }

            // Format the results into a nice HTML string
            let htmlResponse = `<h4>Here are some phones that match your request:</h4>`;
            filteredResults.slice(0, 5).forEach(phone => { // Show top 5
                htmlResponse += `
                    <div class="card my-2">
                        <div class="card-body">
                            <h5 class="card-title">${phone['Model Name'] || 'Unknown Model'}</h5>
                            <ul class="list-unstyled">
                                ${phone.RAM_GB ? `<li><strong>RAM:</strong> ${phone.RAM_GB} GB</li>` : ''}
                                ${phone.Battery_mAh ? `<li><strong>Battery:</strong> ${phone.Battery_mAh} mAh</li>` : ''}
                                ${phone.BackCamera_MP ? `<li><strong>Camera:</strong> ${phone.BackCamera_MP} MP</li>` : ''}
                                ${phone.Price_USD ? `<li><strong>Price:</strong> ~$${phone.Price_USD}</li>` : ''}
                            </ul>
                        </div>
                    </div>
                `;
            });
            return htmlResponse;
        }

        // --- 5. General chat logic (API call) ---
        async function getGeneralResponse(input) {
            const responseDiv = document.getElementById('response');
            try {
                // IMPORTANT: This API key is visible in the frontend code.
                // For a real application, this should be handled via a secure backend.
                const apiKey = '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';
                const response = await fetch(
                    'https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'deepseek/deepseek-chat:free', // Using a reliable free model
                            messages: [{ role: 'user', content: input }],
                        }),
                    },
                );
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                const markdownText = data.choices?.[0]?.message?.content || 'No response received.';
                responseDiv.innerHTML = marked.parse(markdownText);

            } catch (error) {
                console.error("API Error:", error);
                responseDiv.innerHTML = 'Error communicating with the AI model: ' + error.message;
            }
        }
    </script>
</body>
</html>
